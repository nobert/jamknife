services:
  jamknife:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jamknife
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # ListenBrainz configuration
      LISTENBRAINZ_USERNAME: ${LISTENBRAINZ_USERNAME}
      LISTENBRAINZ_TOKEN: ${LISTENBRAINZ_TOKEN:-}
      
      # Plex configuration
      PLEX_URL: ${PLEX_URL}
      PLEX_TOKEN: ${PLEX_TOKEN}
      PLEX_MUSIC_LIBRARY: ${PLEX_MUSIC_LIBRARY:-Music}
      
      # Yubal configuration
      YUBAL_URL: ${YUBAL_URL:-http://yubal:8000}
      
      # Data directories (inside container)
      DATA_DIR: /data
      DOWNLOADS_DIR: /downloads
      
      # Web server
      WEB_HOST: "0.0.0.0"
      WEB_PORT: "8080"
    volumes:
      # Persistent data storage
      - jamknife-data:/data
      # Downloads directory - should be accessible by Plex
      - ${DOWNLOADS_PATH:-./downloads}:/downloads
    networks:
      - jamknife-net
    depends_on:
      yubal:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8080/api/status', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  yubal:
    image: ghcr.io/your-yubal-image:latest  # Replace with actual Yubal image
    container_name: yubal
    restart: unless-stopped
    environment:
      # Configure Yubal to output to shared downloads directory
      OUTPUT_DIR: /downloads
    volumes:
      - ${DOWNLOADS_PATH:-./downloads}:/downloads
    networks:
      - jamknife-net

volumes:
  jamknife-data:
    name: jamknife-data

networks:
  jamknife-net:
    name: jamknife-net
    driver: bridge
